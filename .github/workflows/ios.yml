name: iOS CI
on: [push, pull_request]
jobs:
  build:
    runs-on: macos-14
    env:
      SCHEME: DentalAI
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Show Xcode + SDKs
        run: |
          xcodebuild -version
          xcodebuild -showsdks

      - name: List schemes
        run: |
          chmod +x scripts/ci_list_schemes.sh || true
          ./scripts/ci_list_schemes.sh || true

      - name: Detect workspace/project
        id: detect
        shell: bash
        run: |
          set -euo pipefail
          if [ -e "DentalAI.xcworkspace" ]; then
            echo "ws=-workspace DentalAI.xcworkspace" >> $GITHUB_OUTPUT
          else
            echo "ws=-project DentalAI.xcodeproj" >> $GITHUB_OUTPUT
          fi
          echo "Using fixed scheme: ${{ env.SCHEME }}"

      - name: Resolve packages
        run: |
          xcodebuild ${{ steps.detect.outputs.ws }} \
            -scheme "${{ env.SCHEME }}" \
            -resolvePackageDependencies

      - name: Build (generic simulator, no signing)
        env:
          NSUnbufferedIO: "YES"
        run: |
          set -o pipefail
          : > build.log
          xcodebuild ${{ steps.detect.outputs.ws }} \
            -scheme "${{ env.SCHEME }}" \
            -destination 'generic/platform=iOS Simulator' \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO \
            CODE_SIGNING_REQUIRED=NO \
            clean build 2>&1 | tee -a build.log

      - name: Show first error (if any)
        if: failure()
        run: |
          echo "----- FIRST ERROR CONTEXT -----"
          awk '/^error:|^fatal error:/ {print; exit}' build.log || true
          echo "----- LAST 120 LINES -----"
          tail -n 120 build.log || true

      - name: Upload build log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: build.log