name: iOS CI
on: [push, pull_request]

jobs:
  build:
    runs-on: macos-14
    env:
      SCHEME: DentalAI
    defaults:
      run:
        shell: bash
    steps:
      - uses: actions/checkout@v4

      - name: Select Xcode
        run: sudo xcode-select -s /Applications/Xcode.app

      - name: Show Xcode + SDKs
        run: |
          set -x
          xcodebuild -version || true
          xcodebuild -showsdks || true

      - name: List schemes (project + workspace)
        run: |
          set -x
          : > build.log
          echo "== PROJECT SCHEMES ==" | tee -a build.log
          xcodebuild -list -project DentalAI.xcodeproj 2>&1 | tee -a build.log || true
          if [ -e "DentalAI.xcworkspace" ]; then
            echo "== WORKSPACE SCHEMES ==" | tee -a build.log
            xcodebuild -list -workspace DentalAI.xcworkspace 2>&1 | tee -a build.log || true
          fi

      - name: Detect container
        id: detect
        run: |
          set -euo pipefail
          # prefer project first to avoid "scheme only in project" edge case
          if xcodebuild -list -project DentalAI.xcodeproj >/dev/null 2>&1; then
            WS="-project DentalAI.xcodeproj"
          else
            WS="-workspace DentalAI.xcworkspace"
          fi
          echo "ws=$WS" >> $GITHUB_OUTPUT
          echo "Using fixed scheme: ${{ env.SCHEME }}" | tee -a build.log

      - name: Resolve packages
        run: |
          set -o pipefail
          xcodebuild ${{ steps.detect.outputs.ws }} \
            -scheme "${{ env.SCHEME }}" \
            -resolvePackageDependencies 2>&1 | tee -a build.log

      - name: Build (generic simulator, no signing)
        env:
          NSUnbufferedIO: "YES"
        run: |
          set -o pipefail
          : > build.log
          xcodebuild ${{ steps.detect.outputs.ws }} \
            -scheme "${{ env.SCHEME }}" \
            -destination 'generic/platform=iOS Simulator' \
            -sdk iphonesimulator \
            CODE_SIGNING_ALLOWED=NO CODE_SIGNING_REQUIRED=NO \
            clean build 2>&1 | tee -a build.log

      - name: Show first error (if any)
        if: failure()
        run: |
          echo "----- FIRST ERROR CONTEXT -----"
          awk '/^error:|^fatal error:/ {print; exit}' build.log || true
          echo "----- LAST 150 LINES -----"
          tail -n 150 build.log || true

      - name: Upload build.log
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: build-log
          path: ./build.log